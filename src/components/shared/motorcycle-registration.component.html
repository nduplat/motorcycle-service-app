<div class="motorcycle-registration-container">
  <!-- Header -->
  <header class="registration-header">
    <h2>Registro de Motocicleta</h2>
    <p>Ingresa la placa de tu motocicleta para registrarla o reclamar propiedad.</p>
  </header>

  <!-- Error Display -->
  @if (error()) {
    <div class="error-message">
      <i class="icon-error"></i>
      {{ error() }}
    </div>
  }

  <!-- Success Message -->
  @if (successMessage()) {
    <div class="success-message">
      <i class="icon-success"></i>
      {{ successMessage() }}
    </div>
  }

  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Procesando...</p>
    </div>
  }

  <!-- STATE: Plate Input -->
  @if (currentState() === 'input') {
    <div class="step-content plate-input-step">
      <form [formGroup]="plateForm" (ngSubmit)="onPlateSubmit()" class="plate-form">
        <div class="form-group">
          <label for="plate">Placa de la Motocicleta</label>
          <input
            id="plate"
            type="text"
            formControlName="plate"
            placeholder="ABC123"
            maxlength="6"
            (input)="onPlateInput($event)"
            [class.error]="plateForm.get('plate')?.invalid && plateForm.get('plate')?.touched"
          />
          @if (plateForm.get('plate')?.invalid && plateForm.get('plate')?.touched) {
            <span class="error-text">Placa inválida (formato: ABC123)</span>
          }
          <small class="help-text">Ingresa la placa en formato ABC123 (3 letras mayúsculas + 3 números)</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancel()">Cancelar</button>
          <button type="submit" class="btn-primary" [disabled]="plateForm.invalid">
            Verificar Placa
          </button>
        </div>
      </form>
    </div>
  }

  <!-- STATE: Existing Motorcycle Found -->
  @if (currentState() === 'existing-found') {
    <div class="step-content existing-found-step">
      <div class="motorcycle-info-card">
        <h3>¡Motocicleta Encontrada!</h3>
        <p>Esta motocicleta ya está registrada en el sistema.</p>

        <div class="motorcycle-details">
          <div class="detail-row">
            <strong>Placa:</strong> {{ foundMotorcycle()!.plate }}
          </div>
          <div class="detail-row">
            <strong>Marca:</strong> {{ foundMotorcycle()!.brand }}
          </div>
          <div class="detail-row">
            <strong>Modelo:</strong> {{ foundMotorcycle()!.model }}
          </div>
          <div class="detail-row">
            <strong>Año:</strong> {{ foundMotorcycle()!.year }}
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="goBack()">Cambiar Placa</button>
          <button type="button" class="btn-primary" (click)="motorcycleRegistered.emit(foundMotorcycle()!)">
            Continuar con esta Motocicleta
          </button>
        </div>
      </div>
    </div>
  }

  <!-- STATE: Claim Ownership -->
  @if (currentState() === 'claiming-ownership') {
    <div class="step-content claim-ownership-step">
      <div class="motorcycle-info-card">
        <h3>Motocicleta Registrada por Otro Usuario</h3>
        <p>Esta motocicleta ya está registrada en el sistema, pero no está asignada a tu cuenta.</p>

        <div class="motorcycle-details">
          <div class="detail-row">
            <strong>Placa:</strong> {{ foundMotorcycle()!.plate }}
          </div>
          <div class="detail-row">
            <strong>Marca:</strong> {{ foundMotorcycle()!.brand }}
          </div>
          <div class="detail-row">
            <strong>Modelo:</strong> {{ foundMotorcycle()!.model }}
          </div>
        </div>

        <div class="ownership-notice">
          <p><strong>Nota:</strong> Si eres el propietario de esta motocicleta, puedes reclamar la propiedad contactando al administrador del taller.</p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="goBack()">Cambiar Placa</button>
          <button type="button" class="btn-outline" (click)="claimOwnership()">
            Solicitar Reclamo de Propiedad
          </button>
        </div>
      </div>
    </div>
  }

  <!-- STATE: Create New Motorcycle -->
  @if (currentState() === 'creating-new') {
    <div class="step-content create-new-step">
      <h3>Registrar Nueva Motocicleta</h3>
      <p>Esta placa no está registrada en el sistema. Completa la información para crear un nuevo registro.</p>

      <form [formGroup]="newMotorcycleForm" (ngSubmit)="createNewMotorcycle()" class="new-motorcycle-form">
        <div class="form-row">
          <div class="form-group">
            <label for="brand">Marca</label>
            <input
              id="brand"
              type="text"
              formControlName="brand"
              placeholder="Honda, Yamaha, etc."
              [class.error]="newMotorcycleForm.get('brand')?.invalid && newMotorcycleForm.get('brand')?.touched"
            />
            @if (newMotorcycleForm.get('brand')?.invalid && newMotorcycleForm.get('brand')?.touched) {
              <span class="error-text">Marca requerida</span>
            }
          </div>

          <div class="form-group">
            <label for="model">Modelo</label>
            <input
              id="model"
              type="text"
              formControlName="model"
              placeholder="CB190R, MT-03, etc."
              [class.error]="newMotorcycleForm.get('model')?.invalid && newMotorcycleForm.get('model')?.touched"
            />
            @if (newMotorcycleForm.get('model')?.invalid && newMotorcycleForm.get('model')?.touched) {
              <span class="error-text">Modelo requerido</span>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="year">Año</label>
            <input
              id="year"
              type="number"
              formControlName="year"
              min="1900"
              max="2025"
              [class.error]="newMotorcycleForm.get('year')?.invalid && newMotorcycleForm.get('year')?.touched"
            />
            @if (newMotorcycleForm.get('year')?.invalid && newMotorcycleForm.get('year')?.touched) {
              <span class="error-text">Año válido requerido</span>
            }
          </div>

          <div class="form-group">
            <label for="mileage">Kilometraje Actual</label>
            <input
              id="mileage"
              type="number"
              formControlName="mileageKm"
              placeholder="0"
              min="0"
              [class.error]="newMotorcycleForm.get('mileageKm')?.invalid && newMotorcycleForm.get('mileageKm')?.touched"
            />
            @if (newMotorcycleForm.get('mileageKm')?.invalid && newMotorcycleForm.get('mileageKm')?.touched) {
              <span class="error-text">Kilometraje válido requerido</span>
            }
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="goBack()">Cambiar Placa</button>
          <button type="submit" class="btn-primary" [disabled]="newMotorcycleForm.invalid">
            Registrar Motocicleta
          </button>
        </div>
      </form>
    </div>
  }

  <!-- STATE: Success -->
  @if (currentState() === 'success') {
    <div class="step-content success-step">
      <div class="success-card">
        <div class="success-icon">
          <i class="icon-check"></i>
        </div>
        <h3>¡Registro Exitoso!</h3>
        <p>La motocicleta ha sido registrada correctamente.</p>

        @if (registeredMotorcycle()) {
          <div class="registered-motorcycle-info">
            <div class="detail-row">
              <strong>Placa:</strong> {{ registeredMotorcycle()!.plate }}
            </div>
            <div class="detail-row">
              <strong>Marca:</strong> {{ registeredMotorcycle()!.brand }}
            </div>
            <div class="detail-row">
              <strong>Modelo:</strong> {{ registeredMotorcycle()!.model }}
            </div>
          </div>
        }

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="reset()">Registrar Otra</button>
          <button type="button" class="btn-primary" (click)="motorcycleRegistered.emit(registeredMotorcycle()!)">
            Continuar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- STATE: Error -->
  @if (currentState() === 'error') {
    <div class="step-content error-step">
      <div class="error-card">
        <div class="error-icon">
          <i class="icon-error"></i>
        </div>
        <h3>Error en el Registro</h3>
        <p>{{ error() }}</p>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="goBack()">Intentar de Nuevo</button>
          <button type="button" class="btn-outline" (click)="cancel()">Cancelar</button>
        </div>
      </div>
    </div>
  }
</div>