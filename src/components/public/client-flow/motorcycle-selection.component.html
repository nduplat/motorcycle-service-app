<!-- Motorcycle Selection Component Template -->

<div class="motorcycle-selection-container">
  <!-- Header Section -->
  <div class="step-header">
    <div class="step-icon">
      <span class="icon">{{ getMotorcycleIcon() }}</span>
    </div>
    <h2 class="step-title">{{ flowService.getStepTitle('motorcycle') }}</h2>
    <p class="step-description">{{ flowService.getStepDescription('motorcycle') }}</p>
  </div>

  <!-- Main Content -->
  <div class="motorcycle-selection-section">

    <!-- PRIMERO: Mostrar motos del usuario -->
    @if(userMotorcycles().length > 0) {
      <div class="user-motorcycles-section">
        <h3>Tus Motocicletas Registradas</h3>
        <div class="motorcycles-results-grid">
          @for (moto of userMotorcycles(); track moto.id) {
            <button
              type="button"
              class="motorcycle-result-item"
              [class.selected]="selectedMotorcycle()?.id === moto.motorcycleId"
              (click)="selectUserMotorcycle(moto)">
              <div class="motorcycle-result-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
              <div class="motorcycle-result-info">
                <h4 class="motorcycle-result-name">{{ moto.brand }} {{ moto.model }}</h4>
                <p class="motorcycle-result-year">Placa {{ moto.plate }}</p>
                <span class="registered-badge">
                  <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  Tuya
                </span>
              </div>
              @if (selectedMotorcycle()?.id === moto.motorcycleId) {
                <div class="selection-indicator">
                  <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              }
            </button>
          }
        </div>
      </div>
    }

    <!-- DESPUÉS: Opción de agregar nueva -->
    <div class="add-new-motorcycle-section">
      <button
        type="button"
        class="btn-add-new-motorcycle"
        (click)="onAddNewMotorcycle()">
        <svg class="add-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Añadir nueva moto
      </button>
    </div>

    <!-- Modal con NuevaMotocicletaComponent -->
    <app-nueva-motocicleta
      *ngIf="showNewMotorcycleModal()"
      (motorcycleAssigned)="onMotorcycleAdded($event)"
      (cancel)="showNewMotorcycleModal.set(false)">
    </app-nueva-motocicleta>

    <!-- Motorcycle Search Interface -->
    @if (showMotorcycleSearch() && !showNewMotorcycleModal()) {
      <div class="motorcycle-search-container">
        <!-- Search Input -->
        <div class="search-input-section">
          <div class="search-input-container">
            <input
              type="text"
              [(ngModel)]="motorcycleSearchQuery"
              placeholder="Buscar motocicleta (marca, modelo, año)..."
              class="search-input"
              autocomplete="off">
            <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            @if (motorcycleSearchQuery()) {
              <button
                type="button"
                class="clear-search-btn"
                (click)="motorcycleSearchQuery.set('')"
                aria-label="Limpiar búsqueda">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            }
          </div>
        </div>

        <!-- Search Results -->
        <div class="search-results-section">
          @if (filteredMotorcycles().length === 0) {
            <div class="no-results-message">
              <svg class="no-results-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
              <p class="no-results-text">No se encontraron motocicletas</p>
            </div>
          } @else {
            <div class="motorcycles-results-grid">
              @for (motorcycle of filteredMotorcycles(); track motorcycle.id) {
                <button
                  type="button"
                  class="motorcycle-result-item"
                  [class.selected]="selectedMotorcycle()?.id === motorcycle.id"
                  (click)="onMotorcycleSearchSelect(motorcycle)">
                  <div class="motorcycle-result-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                  </div>
                  <div class="motorcycle-result-info">
                    <h4 class="motorcycle-result-name">{{ motorcycle.brand }} {{ motorcycle.model }}</h4>
                    <p class="motorcycle-result-year">Año {{ motorcycle.year }}</p>
                    @if (isMotorcycleRegistered()(motorcycle.id)) {
                      <span class="registered-badge">
                        <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Registrada
                      </span>
                    }
                  </div>
                  @if (selectedMotorcycle()?.id === motorcycle.id) {
                    <div class="selection-indicator">
                      <svg class="check-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  }
                </button>
              }
            </div>
          }
        </div>
      </div>
    }

    <!-- License Plate Input -->
    @if (selectedMotorcycle()) {
      <div class="input-card">
        <div class="card-header">
          <h3>Información de la motocicleta</h3>
          <p>Completa los datos de {{ getMotorcycleDisplayName(selectedMotorcycle()!) }}</p>
        </div>

        <form class="motorcycle-form">
          <!-- License Plate -->
          <div class="input-group">
            <label for="licensePlate" class="input-label">
              Placa de la motocicleta
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input
                id="licensePlate"
                type="text"
                class="license-plate-input"
                [class]="hasValidationError('licensePlate') ? 'invalid' : (isLicensePlateValid() ? 'valid' : '')"
                placeholder="ABC123"
                [value]="licensePlateInput()"
                (input)="onLicensePlateInput($event)"
                maxlength="6"
                autocomplete="off"
                required>
              <div class="input-icon">
                @if (isLicensePlateValid()) {
                  <span class="valid-icon">✅</span>
                } @else {
                  <span class="plate-icon">🔢</span>
                }
              </div>
            </div>
            @if (hasValidationError('licensePlate')) {
              <div class="validation-message error">
                {{ getValidationError('licensePlate') }}
              </div>
            }
            @if (licensePlateInput() && isLicensePlateValid()) {
              <div class="formatted-display">
                <small class="formatted-text">
                  Formato: {{ formatLicensePlate(licensePlateInput()) }}
                </small>
              </div>
            }
          </div>

          <!-- Mileage -->
          <div class="input-group">
            <label for="mileage" class="input-label">
              Kilometraje actual
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input
                id="mileage"
                type="text"
                class="mileage-input"
                [class]="hasValidationError('mileage') ? 'invalid' : (isMileageValid() ? 'valid' : '')"
                placeholder="12345"
                [value]="mileageInput()"
                (input)="onMileageInput($event)"
                maxlength="7"
                autocomplete="off"
                required>
              <div class="input-icon">
                @if (isMileageValid()) {
                  <span class="valid-icon">✅</span>
                } @else {
                  <span class="mileage-icon">📊</span>
                }
              </div>
            </div>
            @if (hasValidationError('mileage')) {
              <div class="validation-message error">
                {{ getValidationError('mileage') }}
              </div>
            }
            @if (formattedMileage()) {
              <div class="formatted-display">
                <small class="formatted-text">
                  Formato: {{ formattedMileage() }} km
                </small>
              </div>
            }
          </div>
        </form>
      </div>
    }

    <!-- General Error Message -->
    @if (hasValidationError('general')) {
      <div class="error-message">
        <span class="error-icon">⚠️</span>
        {{ getValidationError('general') }}
      </div>
    }
  </div>

  <!-- Action Buttons -->
  <div class="action-section">
    <div class="action-buttons">
      <button
        type="button"
        class="btn-secondary"
        (click)="onPrevious()">
        ← Anterior
      </button>
      <button
        type="button"
        class="btn-primary"
        [disabled]="!isFormValid() || isValidating()"
        (click)="onConfirmSelection()">
        @if (isValidating()) {
          <span class="btn-spinner">⏳</span>
          Validando...
        } @else {
          Continuar
        }
      </button>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="progress-section">
    <div class="progress-bar">
      <div
        class="progress-fill"
        [style.width.%]="flowState().progress">
      </div>
    </div>
    <div class="progress-text">
      Paso 2 de 4 - {{ flowState().progress }}% completado
    </div>
  </div>
</div>