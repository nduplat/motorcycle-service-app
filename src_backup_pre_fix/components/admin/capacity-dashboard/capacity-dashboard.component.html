<div class="capacity-dashboard">
  <div class="capacity-dashboard__header">
    <h1 class="capacity-dashboard__title">Dashboard de Capacidad del Taller</h1>
    <button mat-raised-button
            class="capacity-dashboard__refresh-button"
            color="primary"
            (click)="refreshData()">
      <mat-icon>refresh</mat-icon>
      Actualizar
    </button>
  </div>

  <!-- Overload Alerts -->
  @if(overloadAlerts().length > 0) {
    <mat-card class="capacity-dashboard__alerts-card">
      <mat-card-header>
        <mat-card-title class="capacity-dashboard__alert-content">
          <mat-icon class="capacity-dashboard__alert-icon"
                    [style.color]="overloadAlerts()[0].type === 'critical' ? 'red' : 'orange'">
            warning
          </mat-icon>
          Alertas de Capacidad
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="capacity-dashboard__alerts">
          @for(alert of overloadAlerts(); track alert.message) {
            <div class="capacity-dashboard__alert capacity-dashboard__alert--{{ alert.type }}">
              <div class="capacity-dashboard__alert-content">
                <div class="capacity-dashboard__alert-content">
                  <mat-icon class="capacity-dashboard__alert-icon"
                           [style.color]="alert.type === 'critical' ? 'red' : alert.type === 'warning' ? 'orange' : 'blue'">
                    {{ alert.type === 'critical' ? 'error' : alert.type === 'warning' ? 'warning' : 'info' }}
                  </mat-icon>
                  <span class="capacity-dashboard__alert-message">{{ alert.message }}</span>
                </div>
                @if(alert.action) {
                  <mat-chip class="capacity-dashboard__alert-action"
                           [color]="alert.type === 'critical' ? 'warn' : 'accent'">
                    {{ alert.action }}
                  </mat-chip>
                }
              </div>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Real-time Capacity Meter -->
  @if(currentCapacity(); as capacity) {
    <div class="capacity-dashboard__grid">
      <!-- Capacity Overview -->
      <mat-card class="capacity-dashboard__capacity-card">
        <mat-card-header>
          <mat-card-title>Capacidad Actual</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="capacity-dashboard__capacity-meter">
            <div class="capacity-dashboard__utilization-rate capacity-dashboard__utilization-rate--{{ capacity.utilizationRate >= 90 ? 'critical' : capacity.utilizationRate >= 80 ? 'warning' : 'normal' }}">
              {{ capacity.utilizationRate.toFixed(1) }}%
            </div>
            <div class="capacity-dashboard__utilization-status">
              {{ getCapacityStatus(capacity.utilizationRate) }}
            </div>

            <mat-progress-bar
              mode="determinate"
              [value]="capacity.utilizationRate"
              [color]="getCapacityColor(capacity.utilizationRate)">
            </mat-progress-bar>

            <div class="capacity-dashboard__capacity-details">
              <div>
                <span>Capacidad Total:</span>
                <span>{{ capacity.totalCapacity }}</span>
              </div>
              <div>
                <span>En Uso:</span>
                <span>{{ capacity.usedCapacity }}</span>
              </div>
              <div>
                <span>Disponible:</span>
                <span>{{ capacity.availableCapacity }}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Active Work Orders -->
      <mat-card class="capacity-dashboard__metric-card">
        <mat-card-header>
          <mat-card-title>Órdenes de Trabajo Activas</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="capacity-dashboard__metric-value capacity-dashboard__metric-value--primary">
            {{ capacity.activeWorkOrders }}
          </div>
          <div class="capacity-dashboard__metric-label">
            órdenes en progreso
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Technicians Available -->
      <mat-card class="capacity-dashboard__metric-card">
        <mat-card-header>
          <mat-card-title>Técnicos Disponibles</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="capacity-dashboard__metric-value capacity-dashboard__metric-value--green">
            {{ capacity.availableTechnicians }}
          </div>
          <div class="capacity-dashboard__metric-label">
            de {{ Math.ceil(capacity.totalCapacity / 8) }} total
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Load Trend Chart -->
    <mat-card class="capacity-dashboard__chart-card">
      <mat-card-header>
        <mat-card-title>Tendencia de Carga (Últimas 24 horas)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="capacity-dashboard__chart-container">
          <canvas baseChart
                  [data]="capacityTrendData()"
                  [options]="chartOptions"
                  type="line">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Scheduled Appointments Today -->
    <mat-card class="capacity-dashboard__metric-card">
      <mat-card-header>
        <mat-card-title>Citas Programadas para Hoy</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="capacity-dashboard__metric-value capacity-dashboard__metric-value--purple">
          {{ capacity.scheduledAppointments }}
        </div>
        <div class="capacity-dashboard__metric-label">
          citas confirmadas
        </div>
      </mat-card-content>
    </mat-card>
  } @else {
    <!-- Loading State -->
    <mat-card class="capacity-dashboard__loading">
      <mat-card-content>
        <div class="capacity-dashboard__loading">
          <mat-icon>refresh</mat-icon>
          <p>Cargando datos de capacidad...</p>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>